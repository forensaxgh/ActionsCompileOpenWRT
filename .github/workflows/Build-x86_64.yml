name: Build OpenWrt x86-64
on: 
  workflow_dispatch:
  schedule:
    - cron: 0 20 * * *
env:
  TZ: Asia/Shanghai
jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: æ£€æŸ¥æœåŠ¡å™¨é…ç½®
      run: |
        echo "è­¦å‘Šâš "
        echo "åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½æœ‰é™ï¼Œè‹¥é€‰æ‹©çš„æ’ä»¶è¿‡å¤šï¼ŒåŠ¡å¿…æ³¨æ„CPUæ€§èƒ½ï¼"
        echo -e "å·²çŸ¥CPUå‹å·(é™åº): 7763ï¼Œ8370Cï¼Œ8272CLï¼Œ8171Mï¼ŒE5-2673\n"
        echo "--------------------------CPUä¿¡æ¯--------------------------"
        echo "CPUç‰©ç†æ•°é‡: $(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
        echo "CPUæ ¸å¿ƒæ•°é‡: $(nproc)"
        echo -e "CPUå‹å·ä¿¡æ¯:$(cat /proc/cpuinfo | grep -m1 name | awk -F: '{print $2}')\n"
        echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
        echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯:"
        echo -e "$(sudo lshw -short -C memory | grep GiB)\n"
        echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
        echo "ç¡¬ç›˜æ•°é‡: $(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT
    - name: é‡Šæ”¾ç£ç›˜ç©ºé—´
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        docker rmi `docker images -q`
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL /etc/mysql /etc/php $AGENT_TOOLSDIRECTORY
        sudo -E apt-get -y purge azure-cli* docker* ghc* zulu* hhvm* llvm* firefox* google* dotnet* aspnetcore* powershell* openjdk* adoptopenjdk* mysql* php* mongodb* moby* snap* || true
        sudo -E systemctl daemon-reload
        sudo -E apt-get -y autoremove --purge
        sudo -E apt-get -y clean
        echo "--------------------ç¡¬ç›˜ä¿¡æ¯--------------------------------"
        echo "ç¡¬ç›˜æ•°é‡: $(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT

    - name: æœ€å¤§åŒ–ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        swap-size-mb: 1024
        temp-reserve-mb: 100
        root-reserve-mb: 1024

    - name: æ£€æŸ¥ç¡¬ç›˜ä¿¡æ¯
      run: |
        echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
        echo "ç¡¬ç›˜æ•°é‡: $(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT


    - name: å®‰è£…ä¾èµ–
      run: |
        sudo apt update
        sudo apt install build-essential clang flex bison g++ gawk \
        gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
        python3-distutils rsync unzip zlib1g-dev file wget qemu-utils
        echo "-------------------------æŸ¥çœ‹å·¥ä½œç›®å½•-------------------------"
        echo "å½“å‰ä½ç½®ï¼š"&& pwd
        echo "å½“å‰ç›®å½•æ–‡ä»¶ï¼š"&& ls -la
    - name: è¿å‡ºä»£ç 
      uses: actions/checkout@v3
    - name: æŸ¥çœ‹å·¥ä½œç›®å½•
      run: |
        echo "å½“å‰ä½ç½®ï¼š"&& pwd
        echo "å½“å‰ç›®å½•æ–‡ä»¶ï¼š"&& ls -la
    - name: ä¸‹è½½OpenWRTåŠå…¶ä»–åŒ…ä»£ç 
      id: download_code
      run: |
        REPO_URL=https://github.com/openwrt/openwrt
        git clone $REPO_URL openwrt
        cd openwrt
        echo æ‰€æœ‰åˆ†æ”¯ï¼š&&git branch -r
        echo æ‰€æœ‰æ ‡ç­¾ï¼š&&git tag
        LATEST_BRANCH=$(git branch -r | sed 's/origin\///'|tail -n1)
        LATEST_TAG=$(git tag | grep -v 'rc'|tail -n1)
        echo é€‰æ‹©æœ€æ–°åˆ†æ”¯ï¼š$LATEST_BRANCH
        echo é€‰æ‹©æœ€æ–°éRCæ ‡ç­¾ï¼š$LATEST_TAG
        git checkout $LATEST_TAG
        rm -rf package/helloworld
        git clone --depth=1 https://github.com/fw876/helloworld.git package/helloworld
        git clone https://github.com/jerrykuku/luci-theme-argon.git package/luci-theme-argon
        git clone https://github.com/openwrt/packages.git ../gogogo
        git clone https://github.com/xiaorouji/openwrt-passwall.git package/openwrt-passwall
        sed -i 's/192.168.1.1/10.10.10.100/g' package/base-files/files/bin/config_generate
        sed -i 's/192.168./10.10./g' package/base-files/files/bin/config_generate
        sed -i 's/root:::0:99999:7:::/root:$1$DLXGbdIi$CnUIT65bKyIhDXfR520dZ.:0:0:99999:7:::/g' package/base-files/files/etc/shadow
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        rm -rf feeds/packages/lang/golang
        cp -r ../gogogo/lang/golang/ feeds/packages/lang/
        git clone https://github.com/linkease/istore.git ./package/istore
        git clone https://github.com/linkease/nas-packages.git ./package/nas-packages
        git clone https://github.com/linkease/nas-packages-luci.git ./package/nas-packages-luci
        echo "repo_url=${REPO_URL}" >> $GITHUB_OUTPUT
        echo "latest_branch=${LATEST_BRANCH}" >> $GITHUB_OUTPUT
        echo "latest_tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
        echo "-------------------------æŸ¥çœ‹å·¥ä½œç›®å½•-------------------------"
        echo "å½“å‰ä½ç½®ï¼š"&& pwd
        echo "å½“å‰ç›®å½•æ–‡ä»¶ï¼š"&& ls -la
    - name: å¤åˆ¶.configæ–‡ä»¶
      run: |
        cd openwrt
        cp ../config/diffconfig .config
        make defconfig
    - name: é¢„ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        cd openwrt 
        make download -j$(nproc) || make download -j1 V=s
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
    - name: å¼€å§‹ç¼–è¯‘
      run: |
        wget -O "OpenWRT_Bin" https://github.com/Forensax/ActionsCompileOpenWRT/releases/download/v2024.10.30/OpenWRT_Bin_v2024.10.30.zip
        unzip -d openwrt OpenWRT_Bin
    - name: Setup tmate session
      uses: mxschmitt/action-tmate@v3
    - name : ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@master
      with:
        name: OpenWrt Bin
        path: openwrt/bin
    - name: æ‰“åŒ…Binç›®å½•
      run: |
        zip -q -r OpenWRT_Bin_v$(date +"%Y.%m.%d").zip openwrt/bin
    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      run: |
        echo "release_tag=v$(date +"%Y.%m.%d")" >> $GITHUB_OUTPUT
        touch release.txt
        echo "
        ğŸ’» æ¶æ„: x86_64

        ğŸ“‚ æºç : ${{ steps.download_code.outputs.repo_url }}

        ğŸŒ³ åˆ†æ”¯: ${{ steps.download_code.outputs.latest_branch }}

        ğŸ”— æ ‡ç­¾: ${{ steps.download_code.outputs.LATEST_TAG }}

        â±ï¸ ç¼–è¯‘æ—¶é—´: $(date +"%Yå¹´%mæœˆ%dæ—¥%Hæ—¶%Måˆ†")

        ğŸŒ ç®¡ç†åœ°å€: 10.10.10.100

        ğŸ‘¤ ç”¨æˆ·å: root

        ğŸ”’ å¯†ç : @Forensax " >> release.txt

    - name: è‡ªåŠ¨å‘å¸ƒå›ºä»¶åˆ° Releases
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: |
          openwrt/bin/targets/x86/64/*.*
          openwrt/bin/packages/x86_64/base/*passwall*
          openwrt/bin/packages/x86_64/base/*ssr-plus*
          OpenWRT_Bin*.zip
